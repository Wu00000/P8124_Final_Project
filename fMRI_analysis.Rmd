---
title: "fMRI_Analysis"
output: pdf_document
date: "2022-11-27"
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(parallel)
library(pcalg)
library(pchc)
library(ggpubr)
library(ppcor)
library(ComplexHeatmap)
library(circlize)
library(igraph)

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE)

select <- dplyr::select
num.cores <- detectCores() - 1
```


## Import data
```{r}
# Change file extension
# path <- "./data/data/"
# old_names <- list.files(path)
# new_names <- gsub(".1D", ".csv", old_names)
# file.rename(paste0(path, file_names), paste0(path, new_names))

# Import data
pheno <- read_csv("./data/phenotypic_CMU.csv") %>% janitor::clean_names()
```


## Single-subject analysis
```{r, fig.dim = c(12, 14)}
path <- "./data/data/"
indepTest <- gaussCItest
  
# Set asd vs. control
df_file_names <- inner_join(data.frame(name = list.files(path),
                                       sub_id = as.numeric(substring(list.files("./data/data/"), 7, 13))),
                            pheno, by = "sub_id")
asd_files <- df_file_names %>% filter(dx_group == 1) %>% 
  select(1) %>% mutate(name = paste(path, name, sep = ""))
tc_files <- df_file_names %>% filter(dx_group == 2) %>% 
  select(1) %>% mutate(name = paste(path, name, sep = ""))

normalize_val <- function(x){
  t_x <- (x - min(x))/(max(x) - min(x))
  return(t_x)
}

# --- ASD ---
# Randomly select one asd sample
set.seed(12345)
asd_sel <- sample(as.matrix(asd_files), 1)
asd_dat <- fread(asd_sel, select = c(1:160))
suffStat_asd <- list(C = cor(asd_dat), n = nrow(asd_dat))

# Corr
asd_corr <- cor(scale(asd_dat))
t_asd_corr <- normalize_val(asd_corr)
diag(t_asd_corr) <- 0
colnames(t_asd_corr) <- NULL; rownames(t_asd_corr) <- NULL

# Partial corr
asd_pcorr <- pcor(asd_dat)
t_asd_pcorr <- normalize_val(asd_pcorr$estimate)
diag(t_asd_pcorr) <- 0
colnames(t_asd_pcorr) <- NULL; rownames(t_asd_pcorr) <- NULL

# PC
asd_pc <- pc(suffStat_asd, indepTest, alpha = 0.5, m.max = 1,
             p = ncol(asd_dat), verbose = FALSE)

# MMHC
asd_mmhc <- pchc::mmhc(as.matrix(asd_dat), alpha = 0.5, max_k = 1)
asd_mmhc_res <- 1 - exp(asd_mmhc$ini$pvalue)
colnames(asd_mmhc_res) <- NULL; rownames(asd_mmhc_res) <- NULL


# --- TC ---
# Randomly select one tc sample
set.seed(12345)
tc_sel <- sample(as.matrix(tc_files), 1)
tc_dat <- fread(tc_sel, select = c(1:160))
suffStat_tc <- list(C = cor(tc_dat), n = nrow(tc_dat))

# Corr
tc_corr <- cor(scale(tc_dat))
t_tc_corr <- normalize_val(tc_corr)
diag(t_tc_corr) <- 0
colnames(t_tc_corr) <- NULL; rownames(t_tc_corr) <- NULL

# Partial Corr
tc_pcorr <- pcor(tc_dat)
t_tc_pcorr <- normalize_val(tc_pcorr$estimate)
diag(t_tc_pcorr) <- 0
colnames(t_tc_pcorr) <- NULL; rownames(t_tc_pcorr) <- NULL

# PC
tc_pc <- pc(suffStat_tc, indepTest, alpha = 0.5, m.max = 1,
             p = ncol(tc_dat), verbose = FALSE)

# MMHC
tc_mmhc <- pchc::mmhc(as.matrix(tc_dat), alpha = 0.5, max_k = 1)
tc_mmhc_res <- 1 - exp(tc_mmhc$ini$pvalue)
colnames(tc_mmhc_res) <- NULL; rownames(tc_mmhc_res) <- NULL

# Make plots
col_fun <- colorRamp2(c(0, 0.5, 1), c("blue", "white", "red"))

grid.newpage()
pushViewport(viewport(layout = grid.layout(nr = 5, nc = 2)))

# asd
pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 1))
draw(Heatmap(t_asd_corr, col = col_fun, cluster_rows = F, cluster_columns = F,
             show_heatmap_legend = F, column_title = "ASD: Full Correlation"), newpage = F)
upViewport()

pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 1))
draw(Heatmap(t_asd_pcorr, col = col_fun, cluster_rows = F, cluster_columns = F,
             show_heatmap_legend = F, column_title = "ASD: Partial Correlation"), newpage = F)
upViewport()

pushViewport(viewport(layout.pos.row = 3, layout.pos.col = 1))
draw(Heatmap(1 - asd_pc@pMax, col = col_fun, cluster_rows = F, cluster_columns = F,
             show_heatmap_legend = F, column_title = "ASD: PC"), newpage = F)
upViewport()

pushViewport(viewport(layout.pos.row = 4, layout.pos.col = 1))
draw(Heatmap(asd_mmhc_res, col = col_fun, cluster_rows = F, cluster_columns = F,
             show_heatmap_legend = F, column_title = "ASD: MMHC"), newpage = F)
upViewport()

# tc
pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 2))
draw(Heatmap(t_tc_corr, col = col_fun, cluster_rows = F, cluster_columns = F,
             show_heatmap_legend = F, column_title = "TC: Full Correlation"), newpage = F)
upViewport()

pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 2))
draw(Heatmap(t_tc_pcorr, col = col_fun, cluster_rows = F, cluster_columns = F,
             show_heatmap_legend = F, column_title = "TC: Partial Correlation"), newpage = F)
upViewport()

pushViewport(viewport(layout.pos.row = 3, layout.pos.col = 2))
draw(Heatmap(1 - tc_pc@pMax, col = col_fun, cluster_rows = F, cluster_columns = F,
             show_heatmap_legend = F, column_title = "TC: PC"), newpage = F)
upViewport()

pushViewport(viewport(layout.pos.row = 4, layout.pos.col = 2))
draw(Heatmap(tc_mmhc_res, col = col_fun, cluster_rows = F, cluster_columns = F,
             show_heatmap_legend = F, column_title = "TC: MMHC"), newpage = F)
upViewport()
```


## Group analysis
```{r, results='hide'}
# With PC
# --- ASD ---
asd_all_pc <- mclapply(1:nrow(asd_files), function(i) {
  dat <- fread(asd_files[i, ], select = c(1:160))
  suffStat <- list(C = cor(dat), n = nrow(dat))
  
  pc_res <- pc(suffStat, indepTest, alpha = 0.05, m.max = 1,
               p = ncol(dat), verbose = FALSE)
  pc_final <- ifelse(pc_res@pMax < 0.05, 1, 0)
  adj_mat <- graph.adjacency(pc_final, mode = "max")
  eglist <- get.edgelist(adj_mat)
  
}, mc.cores = num.cores)

asd_all_res <- do.call(rbind, asd_all_pc) %>% 
  as.data.frame() %>% 
  group_by(V1, V2) %>% 
  summarise(num = n()) %>% 
  mutate(sel = ifelse(num > (nrow(asd_files) * 0.8), 1, 0)) %>% 
  filter(sel == 1)

# --- TC ---
tc_all_pc <- mclapply(1:nrow(tc_files), function(i) {
  dat <- fread(tc_files[i, ], select = c(1:160))
  suffStat <- list(C = cor(dat), n = nrow(dat))
  
  pc_res <- pc(suffStat, indepTest, alpha = 0.05, m.max = 1,
               p = ncol(dat), verbose = FALSE)
  pc_final <- ifelse(pc_res@pMax < 0.05, 1, 0)
  adj_mat <- graph.adjacency(pc_final, mode = "max")
  eglist <- get.edgelist(adj_mat)
  
}, mc.cores = num.cores)

tc_all_res <- do.call(rbind, tc_all_pc) %>% 
  as.data.frame() %>% 
  group_by(V1, V2) %>% 
  summarise(num = n()) %>% 
  mutate(sel = ifelse(num > (nrow(tc_files) * 0.8), 1, 0)) %>% 
  filter(sel == 1)



```




